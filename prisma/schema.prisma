generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum OrderStatus {
  PENDING
  CANCELED
  PREPARING
  DELIVERING
  DONE
}

enum ImportStatus {
  PENDING
  CANCELED
  DONE
}

model Role {
  id          Int       @id @default(autoincrement())
  code        String    @unique
  name        String    @unique
  permissions String[]
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  accounts    Account[]
}

model Session {
  id           Int      @id @default(autoincrement())
  accountId    Int
  refreshToken String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  lastUsedAt   DateTime
  revoked      Boolean
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  account      Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

model Account {
  id          Int        @id @default(autoincrement())
  name        String
  avatar      String?
  phone       String?
  address     String?
  username    String     @unique
  email       String?    @unique
  password    String
  isActive    Boolean    @default(true)
  roleId      Int
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  warehouseId Int?
  role        Role       @relation(fields: [roleId], references: [id])
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id])
  orders      Order[]
  sessions    Session[]
}

model Warehouse {
  id        Int                @id @default(autoincrement())
  name      String             @unique
  isActive  Boolean            @default(true)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  address   String?
  accounts  Account[]
  products  WarehouseProduct[]
  imports   Import[]
}

model Product {
  id          Int           @id @default(autoincrement())
  name        String
  slug        String        @unique
  images      Image[]
  description String
  categoryId  Int
  category    Category      @relation(fields: [categoryId], references: [id])
  units       ProductUnit[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  isActive    Boolean       @default(true)
}

model Category {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  slug      String    @unique
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]
}

model Image {
  id        Int      @id @default(autoincrement())
  url       String   @unique
  productId Int
  product   Product  @relation(fields: [productId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Unit {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  productUnits ProductUnit[]
}

model ProductUnit {
  productId         Int
  unitId            Int
  sellPrice         Float
  vatPercent        Float
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  product           Product            @relation(fields: [productId], references: [id])
  unit              Unit               @relation(fields: [unitId], references: [id])
  warehouseProducts WarehouseProduct[]
  importItems       ImportItem[]
  orderProducts     OrderProduct[]

  @@id([productId, unitId])
}

model WarehouseProduct {
  warehouseId Int
  productId   Int
  unitId      Int
  quantity    Int         @default(0)
  product     ProductUnit @relation(fields: [productId, unitId], references: [productId, unitId])
  warehouse   Warehouse   @relation(fields: [warehouseId], references: [id])

  @@id([warehouseId, productId, unitId])
  @@index([productId, unitId])
}

model Customer {
  id        Int      @id @default(autoincrement())
  name      String
  email     String?  @unique
  phone     String?  @unique
  address   String?
  debt      Float?   @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]
}

model Supplier {
  id        Int      @id @default(autoincrement())
  name      String
  email     String?  @unique
  phone     String?  @unique
  address   String?
  debt      Float?   @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  imports   Import[]
}

model Import {
  id          Int          @id @default(autoincrement())
  supplierId  Int
  warehouseId Int
  importItems ImportItem[]
  totalAmount Float        @default(0)
  supplier    Supplier     @relation(fields: [supplierId], references: [id])
  warehouse   Warehouse    @relation(fields: [warehouseId], references: [id])
  status      ImportStatus @default(PENDING)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([supplierId])
  @@index([warehouseId])
  @@index([createdAt])
}

model ImportItem {
  importId  Int
  productId Int
  unitId    Int

  quantity    Int
  importPrice Float

  import      Import      @relation(fields: [importId], references: [id])
  productUnit ProductUnit @relation(fields: [productId, unitId], references: [productId, unitId])

  createdAt DateTime @default(now())

  @@id([importId, productId, unitId])
  @@index([productId, unitId])
}

model Delivery {
  id        Int      @id @default(autoincrement())
  name      String
  email     String?  @unique
  phone     String?  @unique
  debt      Float    @default(0)
  isActive  Boolean  @default(true)
  orders    Order[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Order {
  id              Int            @id @default(autoincrement())
  orderCode       String         @unique
  customerId      Int?
  customerName    String
  customerEmail   String
  customerPhone   String
  customerAddress String
  customerPayment Float
  deliveryPerson  String?
  deliveryPhone   String?
  totalAmount     Float
  vatValue        Float
  discountValue   Float?         @default(0)
  toPayAmount     Float
  paidAmount      Float?         @default(0)
  creatorId       Int
  warehouseId     Int
  deliveryId      Int?
  paymentMethodId Int
  createdBy       Account        @relation(fields: [creatorId], references: [id])
  delivery        Delivery?      @relation(fields: [deliveryId], references: [id])
  customer        Customer?      @relation(fields: [customerId], references: [id])
  paymentMethod   PaymentMethod  @relation(fields: [paymentMethodId], references: [id])
  products        OrderProduct[]
  status          OrderStatus    @default(PENDING)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([createdAt])
  @@index([status])
  @@index([warehouseId])
  @@index([creatorId])
  @@index([customerId])
}

model OrderProduct {
  id        Int @id @default(autoincrement())
  orderId   Int
  productId Int
  unitId    Int

  quantity   Int
  sellPrice  Float
  vatPercent Float

  order       Order       @relation(fields: [orderId], references: [id])
  productUnit ProductUnit @relation(fields: [productId, unitId], references: [productId, unitId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([productId, unitId])
}

model PaymentMethod {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]
}
